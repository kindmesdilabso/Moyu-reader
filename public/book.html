<!DOCTYPE html>
<html lang="en" style="width: 100%;height: 100%;">
<head>
    <meta charset="UTF-8">
    <title>read</title>
    <script src="jquery.js"></script>
    <style>
        #bookContent {
            webkit-app-region: drag;
            width: 100%;
            height: 100%;
            overflow: hidden;
            padding: 2px 5px;
            box-sizing: border-box;
            -webkit-user-select:none;
            -moz-user-select:none;
            -ms-user-select:none;
            user-select:none;
        }
        #percent {
            position: fixed;
            right: 2px;
            bottom: 2px;
        }
        #percent input{
            border: none;
            background: none;
            outline: none;
            width: 2.2rem;
        }
        #percent input:focus{
            border: 1px solid #8f8a8a82;
            border-radius: 2px;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none !important;
            margin: 0;
        }
    </style>
</head>
<body style="margin: 0;width: 100%;height: 100%;">
    <div id="bookContent"></div>
    <div id="percent" style=""><input type="number" oninput="percentChange()" />%</div>
    <script>
        let windowLeft = window.screenLeft;
        let windowTop = window.screenTop;
        let config = null;
        let tmpProgress = null;
        let autoPageTimer = null;

        window.bookServices.receiveMsg(function (res){
            if(res.type === 1 && res.data){
                config = res.data;
                $("#bookContent").css("background",config.bgColor).css("color",config.fontColor).css("font-size",config.fontSize + 'px');
                $("#percent").css("color",config.fontColor).css("font-size",(config.fontSize-2) + 'px');
                $("#percent input").css("color",config.fontColor)
                document.removeEventListener('keydown',keyListen);
                document.addEventListener('keydown', keyListen);
                if(config && config.autoPage && config.autoPage !== 0){
                    setPageInterval();
                } else {
                    clearInterval(autoPageTimer);
                }
            } else if(res.type === 2 && res.data){
                $("#bookContent").html(res.data);
                $("#percent input").val(res.progress).css("width", res.progress.toString().length * 0.45 + "rem");
            }
        });

        window.onresize = function(){
            sendWindowData();
        }

        window.onbeforeunload = function(e) {
            let msg = {
                type: 6
            }
            window.bookServices.sendMsg(msg);
        };

        setInterval(function (){
            const nowLeft = window.screenLeft;
            const nowTop = window.screenTop;
            if(nowLeft !== windowLeft || nowTop !== windowTop){
                windowLeft = window.screenLeft;
                windowTop = window.screenTop;
                sendWindowData();
            }
        },5000);

        $("#percent input").keydown(function (e){
            if(e.key === '+' || e.key === '-' || e.key === 'e'){
                return false;
            }
            if(e.keyCode === 13){
                if($("#percent input").val()){
                    tmpProgress = null;
                    let msg = {
                        type: 5,
                        data: $("#percent input").val()
                    }
                    $("#percent input").blur();
                    window.bookServices.sendMsg(msg);
                }
            }
        })

        $("#percent input").focus(function () {
            tmpProgress = $("#percent input").val();
        })

        $("#percent input").blur(function () {
            if(tmpProgress){
                $("#percent input").val(tmpProgress);
            }
        })

        function percentChange (){
            if($("#percent input").val() > 100){
                $("#percent input").val(100)
            } else if ($("#percent input").val() < 0){
                $("#percent input").val(0)
            }
            if($("#percent input").val()){
                let arr = $("#percent input").val().toString().split(".");
                if(arr && arr.length === 2){
                    if(arr[1].length > 2){
                        arr[1] = arr[1].substring(0,2);
                    }
                }
                $("#percent input").val(arr.join("."));
            }
        }

        function keyListen (e) {
            let ctrl = e.ctrlKey,shift = e.shiftKey,alt = e.altKey,meta = e.metaKey;
            let prevKey = config.prev;
            let nextKey = config.next;
            if(prevKey && nextKey){
                prevKey = prevKey.replace('Command','Meta').replace('Win','Meta').replace('Option','Alt');
                nextKey = nextKey.replace('Command','Meta').replace('Win','Meta').replace('Option','Alt');
            }
            let curList = [];
            ctrl ? curList.push('Control') : null;
            shift ? curList.push('Shift') : null;
            alt ? curList.push('Alt') : null;
            meta ? curList.push('Meta') : null;
            if(e.key !== 'Meta' && e.key !== 'Control' && e.key !== 'Alt' && e.key !== 'Shift'){
                curList.push(e.key);
            }
            if(curList && curList.length > 0){
                let prevList = prevKey.split('+');
                let nextList = nextKey.split('+');
                if (prevList && prevList.length > 0) {
                    let flag = true;
                    prevList.forEach(function (val){
                        if($.inArray(val , curList) === -1){
                            flag = false;
                        }
                    });
                    if (flag) {
                        let msg = {
                            type: 4,
                            data: 'prev'
                        }
                        window.bookServices.sendMsg(msg);
                        if(config && config.autoPage && config.autoPage !== 0){
                            setPageInterval();
                        }
                    }
                }
                if (nextList && nextList.length > 0) {
                    let flag = true;
                    nextList.forEach(function (val){
                        if($.inArray(val , curList) === -1){
                            flag = false;
                        }
                    });
                    if (flag) {
                        let msg = {
                            type: 4,
                            data: 'next'
                        }
                        window.bookServices.sendMsg(msg);
                        if(config && config.autoPage && config.autoPage !== 0){
                            setPageInterval();
                        }
                    }
                }
            }
        }

        function setPageInterval(){
            clearInterval(autoPageTimer);
            autoPageTimer = setInterval(function (){
                let msg = {
                    type: 4,
                    data: 'next'
                }
                window.bookServices.sendMsg(msg);
            }, config.autoPage * 1000 );
        }

        function sendWindowData(){
            if(window.screenLeft <= 10 || window.screenLeft > 8000 || window.screenTop <= 10 || window.screenTop > 8000){
                return;
            }
            let msg = {
                type: 3,
                data: {
                    width: document.body.clientWidth,
                    height: document.body.clientHeight,
                    left: window.screenLeft,
                    top: window.screenTop
                }
            }
            window.bookServices.sendMsg(msg);
        }
    </script>
</body>
</html>